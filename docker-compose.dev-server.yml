# Automaker Docker Compose - Server Only (Development Mode)
# Runs only the backend API in a container for use with local Electron.
#
# Usage:
#   docker compose -f docker-compose.dev-server.yml up
#   Then run Electron locally which connects to http://localhost:3008
#
# This mode:
#   - Runs only the backend server in a container
#   - Mounts source code as volumes (live reload)
#   - Server runs with tsx watch for TypeScript changes
#   - Electron runs locally on host machine

services:
  # Development server (backend API only)
  server:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: automaker-dev-server-only
    restart: unless-stopped
    ports:
      - '3008:3008'
    environment:
      # Required
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Optional - Claude CLI OAuth credentials
      - CLAUDE_OAUTH_CREDENTIALS=${CLAUDE_OAUTH_CREDENTIALS:-}

      # Optional - Cursor CLI OAuth token
      - CURSOR_AUTH_TOKEN=${CURSOR_AUTH_TOKEN:-}

      # Optional - authentication
      - AUTOMAKER_API_KEY=${AUTOMAKER_API_KEY:-}

      # Development settings
      - NODE_ENV=development
      - PORT=3008
      - CORS_ORIGIN=http://localhost:3007

      # Optional - restrict to specific directory within container
      - ALLOWED_ROOT_DIRECTORY=${ALLOWED_ROOT_DIRECTORY:-/projects}
      - DATA_DIR=/data

      # Internal - indicates containerized environment
      - IS_CONTAINERIZED=true
    volumes:
      # Mount source code for live reload
      - .:/app:cached

      # Use named volume for node_modules to avoid platform conflicts
      # This ensures native modules are built for the container's architecture
      - automaker-dev-node-modules:/app/node_modules

      # Persist data across restarts - use local data dir for consistent API key
      - ./data:/data:cached

      # Persist CLI configurations
      - automaker-claude-config:/home/automaker/.claude
      - automaker-cursor-config:/home/automaker/.cursor

      # Mount host Claude credentials for reliable auth
      - ~/.claude:/tmp/host-claude-creds:ro

      # Note: Workspace mount (/projects) comes from docker-compose.override.yml

    # Install deps, build packages, then start server in watch mode
    # Note: We override the entrypoint to handle permissions properly
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Fix permissions on node_modules (created as root by Docker volume)
        echo 'Fixing node_modules permissions...'
        chown -R automaker:automaker /app/node_modules 2>/dev/null || true

        # Setup Claude OAuth credentials if provided
        if [ -n "$CLAUDE_OAUTH_CREDENTIALS" ]; then
          echo 'Setting up Claude OAuth credentials...'
          mkdir -p /home/automaker/.claude
          # Use printf to preserve JSON quotes correctly
          printf '%s' "$CLAUDE_OAUTH_CREDENTIALS" > /home/automaker/.claude/.credentials.json
          chmod 600 /home/automaker/.claude/.credentials.json
          chown -R automaker:automaker /home/automaker/.claude
        fi

        # Copy credentials from host mount if available (more reliable)
        if [ -f /tmp/host-claude-creds/.credentials.json ]; then
          echo 'Copying Claude credentials from host...'
          mkdir -p /home/automaker/.claude
          cp /tmp/host-claude-creds/.credentials.json /home/automaker/.claude/
          chmod 600 /home/automaker/.claude/.credentials.json
          chown -R automaker:automaker /home/automaker/.claude
        fi

        # Run the rest as automaker user
        exec gosu automaker sh -c "
          echo 'Cleaning platform-specific packages...' &&
          rm -rf /app/node_modules/*-darwin-* /app/node_modules/*-win32-* 2>/dev/null || true &&
          rm -rf /app/node_modules/.package-lock.json 2>/dev/null || true &&
          echo 'Installing dependencies for Linux...' &&
          npm install --force &&
          echo 'Building shared packages...' &&
          npm run build:packages &&
          echo 'Starting server in development mode...' &&
          npm run _dev:server
        "
    # Allow container to access host services (MEGABRAIN on port 8081)
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3008/api/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

volumes:
  automaker-dev-node-modules:
    name: automaker-dev-node-modules
    # Named volume for container-specific node_modules

  automaker-data:
    name: automaker-data

  automaker-claude-config:
    name: automaker-claude-config

  automaker-cursor-config:
    name: automaker-cursor-config
